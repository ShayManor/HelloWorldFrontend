<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HP5BQC34Z7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-HP5BQC34Z7');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Please enter your equation:</title>

    <!-- Link to Bootstrap CSS for responsive styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <!-- Link to MathQuill CSS for rendering mathematical expressions -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">

    <!-- Link to Google Fonts for custom font styling -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
</head>
<body>
<!-- Navigation bar at the top of the page -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">MathGen</a> <!-- Brand name -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span> <!-- Toggle button for mobile view -->
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto"> <!-- Added 'me-auto' to align items properly -->
                <li class="nav-item">
                    <a class="nav-link" href="Home.html">Home</a> <!-- Home link -->
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">Generate</a> <!-- Current page link -->
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="About.html">About Us</a> <!-- About link -->
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="WProblems.html">Word Problems</a> <!-- Word Problems link -->
                </li>
            </ul>
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <!-- Dropdown Menu for Logged-In Users -->
                <div class="dropdown d-flex align-items-center" id="userDropdown">
                    <button class="dropbtn btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        User Menu
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                        <li class="dropdown-item-text">
                            <span id="remainingRequests" class="text-dark">Remaining Attempts: 5</span>
                        </li>
                        <li class="dropdown-item-text">
                            <span id="userEmailDisplay" class="text-dark">Logged in as user@example.com</span>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button id="logoutBtn" class="dropdown-item">Logout</button></li>
                    </ul>
                </div>
                <!-- Login Button for Logged-Out Users -->
                <div id="loggedOutMenu" class="d-flex align-items-center">
                    <button id="loginBtn" class="btn btn-outline-light">Login with Google</button>
                </div>
            </ul>
        </div>
    </div>
</nav>

<!-- Main content container -->
<div class="container">
    <h3>Please enter your equation:</h3> <!-- Heading for user input -->

    <!-- Display remaining requests -->

    <!-- MathQuill Element for entering mathematical equations -->
    <div id="mathContainer" class="math-container" tabindex="0"></div>

    <!-- Container for symbol buttons categorized by type -->
    <div class="symbol-buttons">
        <div class="category">
            <button class="btn btn-secondary">Calculus</button> <!-- Button for calculus symbols -->
            <div class="symbols">
                <button onmousedown="insertSymbol('\\int')">∫</button> <!-- Integral symbol -->
                <button onmousedown="insertSymbol('\\frac{d}{dx}')">d/dx</button> <!-- Derivative symbol -->
                <button onmousedown="insertSymbol('\\infty')">∞</button> <!-- Infinity symbol -->
                <button onmousedown="insertSymbol('\\sum')">Σ</button> <!-- Summation symbol -->
                <button onmousedown="insertLimit()">lim</button> <!-- Limit symbol -->
            </div>
        </div>

        <div class="category">
            <button class="btn btn-secondary">Algebra</button> <!-- Button for algebra symbols -->
            <div class="symbols">
                <button onmousedown="insertSymbol('\\pm')">±</button> <!-- Plus-minus symbol -->
                <button onmousedown="insertSymbol('\\times')">×</button> <!-- Multiplication symbol -->
                <button onmousedown="insertSymbol('\\div')">÷</button> <!-- Division symbol -->
                <button onmousedown="insertSquareRoot()">√</button> <!-- Square root symbol -->
            </div>
        </div>

        <div class="category">
            <button class="btn btn-secondary">Greek Letters</button> <!-- Button for Greek letters -->
            <div class="symbols">
                <button onmousedown="insertSymbol('\\pi')">π</button> <!-- Pi  symbol -->
                <button onmousedown="insertSymbol('\\alpha')">α</button> <!-- Alpha symbol -->
                <button onmousedown="insertSymbol('\\beta')">β</button> <!-- Beta symbol -->
                <button onmousedown="insertSymbol('\\gamma')">γ</button> <!-- Gamma symbol -->
                <button onmousedown="insertSymbol('\\delta')">δ</button> <!-- Delta symbol -->
                <button onmousedown="insertSymbol('\\epsilon')">ε</button> <!-- Epsilon symbol -->
                <button onmousedown="insertSymbol('\\theta')">θ</button> <!-- Theta symbol -->
                <button onmousedown="insertSymbol('\\omega')">ω</button> <!-- Omega symbol -->
                <button onmousedown="insertSymbol('\\Delta')">Δ</button> <!-- Uppercase Delta symbol -->
                <button onmousedown="insertSymbol('\\nabla')">∇</button> <!-- Nabla symbol -->
            </div>
        </div>

        <div class="category">
            <button class="btn btn-secondary">Logic</button> <!-- Button for logic symbols -->
            <div class="symbols">
                <button onmousedown="insertSymbol('\\forall')">∀</button> <!-- Universal quantifier -->
                <button onmousedown="insertSymbol('\\exists')">∃</button> <!-- Existential quantifier -->
                <button onmousedown="insertSymbol('\\neg')">¬</button> <!-- Negation symbol -->
                <button onmousedown="insertSymbol('\\land')">∧</button> <!-- Logical AND -->
                <button onmousedown="insertSymbol('\\lor')">∨</button> <!-- Logical OR -->
                <button onmousedown="insertSymbol('\\Rightarrow')">⇒</button> <!-- Implication -->
                <button onmousedown="insertSymbol('\\Leftrightarrow')">⇔</button> <!-- Biconditional -->
            </div>
        </div>

        <div class="category">
            <button class="btn btn-secondary">Comparisons</button> <!-- Button for comparison symbols -->
            <div class="symbols">
                <button onmousedown="insertSymbol('\\leq')">≤</button> <!-- Less than or equal to -->
                <button onmousedown="insertSymbol('\\geq')">≥</button> <!-- Greater than or equal to -->
                <button onmousedown="insertSymbol('\\approx')">≈</button> <!-- Approximately equal to -->
                <button onmousedown="insertSymbol('\\equiv')">≡</button> <!-- Identically equal to -->
            </div>
        </div>

    </div>

    <button id="submitBtn">Generate Video</button> <!-- Button to generate the video -->

    <!-- Spinner to indicate loading process -->
    <div class="spinner text-center mt-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span> <!-- Visually hidden loading text -->
        </div>
    </div>

    <!-- Container for the video player, initially hidden -->
    <div class="video-container">
        <video id="videoPlayer" controls class="w-100"> <!-- Video player element -->
            <source id="videoSource" type="video/mp4"> <!-- Source for the video -->
            Your browser does not support the video tag. <!-- Fallback text for unsupported browsers -->
        </video>
    </div>

</div>

<!-- Place scripts at the end of the body -->

<!-- Scripts for Bootstrap and dependencies -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

<!-- Script for MathQuill -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>

<!-- Firebase SDK scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Initialize Firebase -->
<script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyB4lnwZwKB6RbrCf3CGJEpbN-4jKX8zyX0",
        authDomain: "mathgen-f32a0.firebaseapp.com",
        projectId: "mathgen-f32a0",
        storageBucket: "mathgen-f32a0.appspot.com",
        // appId: "YOUR_APP_ID" // Replace with your actual app ID
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    var auth = firebase.auth();
    var db = firebase.firestore();
</script>

<!-- Your custom scripts -->
<script>
    let currentUser = null;

    // Listen for authentication state changes
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            console.log('User logged in:', user.email);
            // Update UI to reflect login status
            document.getElementById('dropdownMenuButton').style.display = 'block';
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('userEmailDisplay').textContent = `Logged in as ${user.email}`;

            // Get usage count from Firestore
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const userDoc = await userDocRef.get();

            let usageCount = 0;
            if (userDoc.exists) {
                usageCount = userDoc.data().usageCount || 0;
            }

            const remainingRequests = 5 - usageCount;
            // Update the UI to show remaining requests
            document.getElementById('remainingRequests').textContent = `Remaining Attempts: ${remainingRequests}`;
            if (usageCount >= 5) {
                alert('You have reached your usage limit of 5 attempts.');
                document.getElementById('submitBtn').disabled = true; // Disable the button
                spinner.style.display = 'none';
                return;
            }

        } else {
            currentUser = null;
            console.log('User logged out');
            // Update UI to reflect logout status
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('dropdownMenuButton').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userEmailDisplay').textContent = '';
            document.getElementById('remainingRequests').textContent = '';
        }
    });

    // Login function
    document.getElementById('loginBtn').addEventListener('click', () => {
        var provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then((result) => {
                console.log('Login successful');
            })
            .catch((error) => {
                console.error('Error during login:', error);
                alert('Login failed. Please try again.');
            });
    });

    // Logout function
    document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut()
            .then(() => {
                console.log('User logged out');
            })
            .catch((error) => {
                console.error('Error during logout:', error);
                alert('Logout failed. Please try again.');
            });
    });

    // Initialize MathQuill
    var MQ = MathQuill.getInterface(2);
    var mathField = MQ.MathField(document.getElementById('mathContainer'), {
        spaceBehavesLikeTab: true,
        handlers: {
            enter: function () {
                document.getElementById('submitBtn').click();
            }
        }
    });

    // Function to insert symbols into the MathQuill input field
    function insertSymbol(symbol) {
        mathField.write(symbol);
    }

    // Function to insert square root symbol
    function insertSquareRoot() {
        mathField.cmd('sqrt');
    }

    function insertLimit() {
        const limitExpression = `\\lim_{a \\to b}`;
        mathField.write(limitExpression);
    }

    // Event listener for the submit button
    document.getElementById('submitBtn').addEventListener('click', function () { // Get references to UI elements
        const spinner = document.querySelector('.spinner'); // Spinner for loading indication
        const videoContainer = document.querySelector('.video-container');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoSource = document.getElementById('videoSource');
        spinner.style.display = 'block';
        videoContainer.style.display = 'none';
        const equation = mathField.latex();

        setTimeout(() => {
            videoSource.src = "https://manors-videos-bucket.s3.us-east-2.amazonaws.com/c9dcd504-9404-11ef-9c17-c6ac684d68cbvideo.mp4";
            videoPlayer.load();
            videoContainer.style.display = 'block';
            spinner.style.display = 'none';
        }, 1000); // 6000ms = 6 seconds
    });
</script>
</body>
</html>
